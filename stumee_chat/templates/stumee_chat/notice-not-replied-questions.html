<script>
    window.addEventListener('load', function() {
        function poll(receivedData) {
            let parsedData = [];
            fetch("{% url "stumee_chat:polling-for-unread-question" course_id %}", {
                    method: 'POST',
                    body: JSON.stringify(receivedData),
                    headers: {
                        'Content-Type': 'application/json; charset=utf-8',
                        'X-CSRFToken': csrftoken,
                    },
                }).then((response) => {
                    // time out error
                    if (response.status == 502) {
                        console.log("status 502");
                    }
                    if (response.status != 200) {
                        console.log("status" + response.status);
                    }
                    return response.json();
                })
                .then((studentsData) => {
                    let newElement = '';
                    let studentsList = document.getElementById('student-name-list');
                    parsedData = JSON.parse(studentsData);
                    parsedData.forEach(student => {
                        newElement +=
                           '<div class="row">'
                           + '<a href= "'
                           + '{% url 'stumee_chat:chat_question' course_id 12345 %}'.replace(/12345/, student.id) //need change!
                           + '" class="list-group-item list-group-item-action col-8 rounded-0 h-100">'
                           + student.username
                           + '</a>'
                           + `<button class="col-3 check-this-question btn btn-outline-secondary rounded-0 h-100" data-checked-question-id="${student.id}">`
                           + '<i class="fas fa-check-circle"></i>'
                           + '</button>'
                           + '</div>'
                    });
                    studentsList.innerHTML = newElement;
                })
                .catch((error) => {
                    console.log("polling error" + error);
                })
                .finally(() => {
                    setTimeout(poll, 2000, parsedData);
                });
        }
        poll([{id: "none", username: "none"}]);

        $("#student-name-list").on("click","button.check-this-question",function(){
            const checkedQuestionID = $(this).attr('data-checked-question-id');
            checkTheQuestion(checkedQuestionID);
        });

        function checkTheQuestion(questionID) {
            fetch("{% url "stumee_chat:inactivate-channel" course_id 12345 %}".replace(/12345/, questionID), {
                method: 'GET',
            }).then((response) => {
                return response.json();
            }).then((responseJson) => {
                console.log(responseJson);
            }).catch((error) => {
                console.log(error);
            });
        }
    })
</script>